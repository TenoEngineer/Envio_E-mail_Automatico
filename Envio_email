'******************* ENVIO DE E-MAIL    *********************
'#AUTHOR: HEITOR TENO MÜLLER | ISMAEL HENRIQUE BUTTENBENDER
'#DATE: 25/11/2021
'#CONTACT: heitor.muller@herval.com.br | heitortmuller@gmail.com

Sub ENVIAR_TODOS_TESTE()
     
    'Mensagem de segurança
     Dim resultado As VbMsgBoxResult
     resultado = MsgBox("Deseja enviar os e-mails?", vbYesNo, "Tomando uma decisão")
     If resultado = vbYes Then
     Else
          MsgBox "Envio de e-mails cancelado cancelada"
          GoTo 10
     End If

    'DESPROTEGE A PLANILHA
    Sheets("Envio").Select
    Run "Desproteger"
    Sheets("E-mail").Select
    Run "Desproteger"
    Sheets("Envio").Select
    Application.Calculation = xlManual
    Application.CalculateBeforeSave = False
    
    Dim usuario As String
    usuario = Environ("Username")
    CAMINHO = "C:\Users\" & usuario
    'INSERE OS CAMINHOS DA PLANILHA
    Dim ASSUNTO As String
    ASSUNTO = Range("H3").Value
    'Dim PLANILHA As String
    'PLANILHA = Range("I4").Value
    
    'ENCONTRA OS E-MAILS
    Dim E_MAIL_1 As String
    Dim E_MAIL_2 As String
    Dim E_MAIL_3 As String
    Dim E_MAIL_4 As String
    Dim ID As String

    'COMEÇA A SELECIONAR OS QUE VÃO MANDAR E-MAIL
    x = 500
    Sheets("Envio").Select
    For i = 1 To x
        If Range("C" & 6 + i).Value = "NÃO" And Range("B" & 6 + i).Value <> Empity Then
            
            ID = Range("B" & 6 + i).Value
            E_MAIL_1 = Range("D" & 6 + i).Value
            E_MAIL_2 = Range("E" & 6 + i).Value
            E_MAIL_3 = Range("F" & 6 + i).Value
            E_MAIL_4 = Range("G" & 6 + i).Value
            
            GoTo 5
            
3           If E_MAIL_1 <> "" Then
                ActiveWorkbook.EnvelopeVisible = True
                With ActiveSheet.MailEnvelope
                    On Error GoTo 6
                    .Item.To = E_MAIL_1 & ";" & E_MAIL_2 & ";" & E_MAIL_3 & ";" & E_MAIL_4
                    .Item.Subject = ASSUNTO & " - " & ID
                    .Introduction = " "
                    .Item.Send
                End With
                ActiveWorkbook.EnvelopeVisible = False
            End If
        
        ActiveWindow.Close
        Application.DisplayAlerts = True
            
        Sheets("Envio").Select
        
        ElseIf Range("C" & 6 + i).Value = "SIM" And Range("B" & 6 + i).Value <> Empity Then

        Else
            Exit For
        End If
        
    Next
    

    
    MsgBox "Envio de E-mails Concluído!"
    GoTo 8
        
    'MANIPULAÇÃO DAS INFORMAÇÕES DO E-MAIL
    
    'Limpa os dados do e-mail anterior
5   Sheets("E-mail").Select
    Rows("5:1000").Select
    Selection.Clear
    
    'Filtra os dados da filial
    Sheets("DIVERGÊNCIAS").Select
    Range("B1").Select
    If ActiveSheet.AutoFilterMode = True Then Selection.AutoFilter
    Range("A1:H1", Range("A1:H1").End(xlDown)).Select
    Selection.AutoFilter
    ActiveSheet.Range("A1:H1", Range("A1:H1").End(xlDown)).AutoFilter Field:=8, Criteria1:="S"
    ActiveSheet.Range("A1:H1", Range("A1:H1").End(xlDown)).AutoFilter Field:=2, Criteria1:=ID
    Range("A1:F1", Range("A1:F1").End(xlDown)).Select
    Selection.SpecialCells(xlCellTypeVisible).Select
    Selection.Copy
    
    'Copia os dados filtrado pra aba e-mail
    Sheets("E-mail").Select
    Range("A5").Select
    ActiveSheet.Paste
    ASSIN = Selection.Rows.Count
    Range("A5").Select
    Selection.PasteSpecial Paste:=xlPasteValues, Operation:=xlNone, SkipBlanks _
        :=False, Transpose:=False
    
    'Insere a assinatura do e-mail
    Sheets("ASSINATURA").Select
    ActiveSheet.Calculate
    Range("A1:D5").Select
    Selection.Copy
    Sheets("E-mail").Select
    Cells(6 + ASSIN, 1).Select
    ActiveSheet.Paste
    Range("A1").Select
    Sheets("DIVERGÊNCIAS").Select
    Range("A1").Select
    Selection.AutoFilter
    
    'Gera um excel novo
    Sheets("E-mail").Select
    Sheets("E-mail").Copy After:=Sheets(3)
    Sheets("E-mail (2)").Name = ID
    ActiveSheet.Calculate
    
    Sheets(ID).Select
    Sheets(ID).Move
    
    Application.DisplayAlerts = False
    
    'Salva o excel em um caminho especifico
    ChDir CAMINHO
    ActiveWorkbook.SaveAs Filename:=CAMINHO & "\" & "E-mail.xls", _
        FileFormat:=xlExcel8, Password:="", WriteResPassword:="", ReadOnlyRecommended:=False, CreateBackup:=False
            
    Sheets(ID).Select
    GoTo 3

6   ActiveWindow.Close
    Application.DisplayAlerts = True
    Calculate
     
    MsgBox "Houve Erro! Clicar em Enviar Todos novamente!"

8   Application.Calculation = xlAutomatic
    Application.CalculateBeforeSave = True
    Sheets("E-mail").Select
    Run "Proteger"
    Sheets("Envio Divergências").Select
    Run "Proteger"
        
10
   
End Sub

Sub Proteger()
    Dim NomeAba As String
    NomeAba = ActiveSheet.Name
    Sheets(NomeAba).Protect ("xxx"), DrawingObjects:=True, Contents:=True, Scenarios:=True _
        , AllowFiltering:=True
End Sub
Sub Desproteger()
    Dim NomeAba As String
    NomeAba = ActiveSheet.Name
    Sheets(NomeAba).Unprotect ("xxx")
End Sub

